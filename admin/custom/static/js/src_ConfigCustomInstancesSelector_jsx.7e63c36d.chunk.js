"use strict";(self.webpackChunkiobroker_admin_component_telegram=self.webpackChunkiobroker_admin_component_telegram||[]).push([["src_ConfigCustomInstancesSelector_jsx"],{4976:(ve,q,x)=>{x.d(q,{A:()=>he});var W=x(8437),u=x.n(W),B=x(5973),O=x.n(B),H=typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const w={randomUUID:H};var U,J=new Uint8Array(16);function L(){if(!U&&(U=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!U))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return U(J)}for(var C=[],G=0;G<256;++G)C.push((G+256).toString(16).slice(1));function N(i,e=0){return(C[i[e+0]]+C[i[e+1]]+C[i[e+2]]+C[i[e+3]]+"-"+C[i[e+4]]+C[i[e+5]]+"-"+C[i[e+6]]+C[i[e+7]]+"-"+C[i[e+8]]+C[i[e+9]]+"-"+C[i[e+10]]+C[i[e+11]]+C[i[e+12]]+C[i[e+13]]+C[i[e+14]]+C[i[e+15]]).toLowerCase()}function fe(i,e=0){var n=N(i,e);if(!validate(n))throw TypeError("Stringified UUID is invalid");return n}const me=null;function Y(i,e,n){if(w.randomUUID&&!e&&!i)return w.randomUUID();i=i||{};var o=i.random||(i.rng||L)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,e){n=n||0;for(var d=0;d<16;++d)e[n+d]=o[d];return e}return N(o)}const T=Y;var p=x(7085),F=x(1839),b=x(556),k=x(5636),K=Object.defineProperty,Q=Object.defineProperties,Z=Object.getOwnPropertyDescriptors,X=Object.getOwnPropertySymbols,ee=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable,se=Reflect.get,z=(i,e,n)=>e in i?K(i,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):i[e]=n,A=(i,e)=>{for(var n in e||(e={}))te.call(e,n)&&z(i,n,e[n]);if(X)for(var n of X(e))ie.call(e,n)&&z(i,n,e[n]);return i},ne=(i,e)=>Q(i,Z(e)),ae=(i,e,n)=>z(i,typeof e!="symbol"?e+"":e,n),re=(i,e,n)=>se(ee(i),n,e),V=(i,e,n)=>new Promise((o,d)=>{var r=c=>{try{a(n.next(c))}catch(t){d(t)}},s=c=>{try{a(n.throw(c))}catch(t){d(t)}},a=c=>c.done?o(c.value):Promise.resolve(c.value).then(r,s);a((n=n.apply(i,e)).next())});const g={table:{minWidth:400},header:{fontSize:16,fontWeight:"bold"},td:{padding:"2px 16px"},vendor:{maxWidth:150,fontSize:12,textOverflow:"ellipsis",overflow:"hidden"}};function le(i,e){return V(this,null,function*(){const n=yield i.getObjectViewSystem("state",`${e}.`,`${e}.\u9999`),o=[],d=Object.keys(n).filter(r=>r.endsWith(".address"));for(let r=0;r<d.length;r++){const s=d[r],a=yield i.getState(s);a!=null&&a.val&&o.push({ip:a.val,name:"homekit-controller"})}return o})}function de(i,e){return V(this,null,function*(){const n=yield i.getObjectViewSystem("state",`${e}.`,`${e}.\u9999`),o=[],d=Object.keys(n).filter(r=>r.endsWith(".address"));for(let r=0;r<d.length;r++){const s=d[r],a=yield i.getState(s);a!=null&&a.val&&o.push({ip:a.val,name:"homekit-controller"})}return o})}function oe(i,e){return V(this,null,function*(){const n=yield i.getObjectViewSystem("state",`${e}.`,`${e}.\u9999`),o=[],d=Object.keys(n).filter(r=>r.endsWith(".hostname"));for(let r=0;r<d.length;r++){const s=d[r],a=yield i.getState(s);a!=null&&a.val&&o.push({ip:a.val,name:"shelly"})}return o})}function ce(i,e){return V(this,null,function*(){var n,o;const d=yield i.getObjectViewSystem("state",`${e}.info.clients.`,`${e}.info.clients.\u9999`),r=[],s=Object.values(d);for(let a=0;a<s.length;a++)(o=(n=s[a])==null?void 0:n.native)!=null&&o.ip&&r.push({ip:s[a].native.ip,name:e.split(".")[0]});return r})}function ue(i,e){return V(this,null,function*(){var n,o,d;const r=yield i.getObjectViewSystem("device",`${e}.`,`${e}.\u9999`),s=Object.values(r),a=[];for(let c=0;c<s.length;c++)((n=s[c])==null?void 0:n.type)==="device"&&((d=(o=s[c])==null?void 0:o.native)!=null&&d.ip)&&a.push({ip:s[c].native.ip,name:e.split(".")[0]});return a})}const pe=[{adapter:"broadlink2",attr:"additional"},{adapter:"harmony",attr:"devices",arrayAttr:"ip"},{adapter:"hm-rpc",attr:"homematicAddress"},{adapter:"homeconnect",browse:de},{adapter:"homekit-controller",attr:"discoverIp",browse:le},{adapter:"hue",attr:"bridge"},{adapter:"knx",attr:"bind"},{adapter:"lgtv",attr:"ip"},{adapter:"loxone",attr:"host"},{adapter:"mihome-vacuum",attr:"ip"},{adapter:"modbus",attr:"params.bind",clients:!0},{adapter:"mqtt",attr:"url",clients:!0},{adapter:"mqtt-client",attr:"host"},{adapter:"lcn",attr:"host"},{adapter:"knx",attr:"gwip"},{adapter:"onvif"},{adapter:"openknx",attr:"gwip"},{adapter:"broadlink2",attr:"additional"},{adapter:"proxmox",attr:"ip"},{adapter:"samsung",attr:"ip"},{adapter:"shelly",browse:oe},{adapter:"sonoff",clients:!0},{adapter:"sonos",attr:"devices",arrayAttr:"ip"},{adapter:"tr-064",attr:"iporhost"},{adapter:"unify",attr:"controllerIp"},{adapter:"upnp",browse:ue},{adapter:"wled",attr:"devices",arrayAttr:"ip"},{adapter:"wifilight",attr:"devices",arrayAttr:"ip"}];function S(i){return i?typeof i!="string"?!1:(i=i.trim().toUpperCase().replace(/\s/g,""),!i||i.match(/^([0-9A-F]{2}[:-]){5}([0-9A-F]{2})$/)?!0:!!i.match(/^([0-9A-F]{12})$/)):!0}function M(i){return!i||!S(i)?i:(i=i.toUpperCase().trim().replace(/[\s:-]/g,""),i.replace(/(..)(..)(..)(..)(..)(..)/,"$1:$2:$3:$4:$5:$6"))}function $(i){return i?typeof i!="string"?!1:(i=i.trim(),i?i.match(/^\d+\.\d+\.\d+\.\d+$/)?!i.trim().split(".").map(n=>parseInt(n,10)).find(n=>n<0||n>255):!1:!0):!0}function D(i){return!i||!$(i)?i:i.trim().split(".").map(n=>parseInt(n,10)).join(".")}class E extends b.ConfigGeneric{constructor(){super(...arguments),ae(this,"onAliveChanged",(e,n)=>{this.state.alive!==!!(n!=null&&n.val)&&this.setState({alive:!!(n!=null&&n.val)},()=>{this.state.alive&&(this.resolveDone?this.validateAddresses():this.resolveMACs())})})}componentDidMount(){return V(this,null,function*(){re(E.prototype,this,"componentDidMount").call(this);let e=[];const n=yield this.props.socket.getObject(`system.adapter.kisshome-research.${this.props.instance}`);n!=null&&n.common.host&&(e=(yield this.props.socket.getObject(`system.host.${n.common.host}`)).common.address);let o=yield this.props.socket.getAdapterInstances();o=o.filter(a=>{var c;return((c=a==null?void 0:a.common)==null?void 0:c.adminUI)&&(a.common.adminUI.config!=="none"||a.common.adminUI.tab)}).map(a=>({id:a._id.replace(/^system\.adapter\./,""),name:a.common.name,native:a.native})).sort((a,c)=>a.id>c.id?1:a.id<c.id?-1:0);const d=b.ConfigGeneric.getValue(this.props.data,"devices")||[];d.forEach(a=>{a.uuid||(a.uuid=T())});const r=yield this.collectIpAddresses(o,e,d),s={instances:o,ips:r,IP2MAC:{},MAC2VENDOR:{},alive:this.props.alive,resolving:!1,showMessage:!1};this.resolveDone=!1,this.setState(s),this.props.socket.subscribeState(`system.adapter.kisshome-research.${this.props.instance}.alive`,this.onAliveChanged),this.props.alive&&this.resolveMACs(),this.disableFritzBox()})}resolveMACs(){this.resolveDone=!0,this.setState({runningRequest:!0},()=>{const e=[...b.ConfigGeneric.getValue(this.props.data,"devices")||[]],n=[];return e.forEach(o=>{const d=D(o.ip),r=M(o.mac);d&&$(d)?n.push({ip:d,mac:r}):r&&S(r)&&n.push({ip:d,mac:r})}),this.state.ips.forEach(o=>{const d=D(o.ip),r=M(o.mac);d&&$(d)&&!n.find(s=>s.ip===d)?n.push({ip:d,mac:r}):r&&S(r)&&!n.find(s=>s.ip===d)&&n.push({ip:d,mac:r})}),this.props.socket.sendTo(`kisshome-research.${this.props.instance}`,"getMacForIps",n).then(o=>{var d;if(o!=null&&o.error){this.setState({runningRequest:!1});return}const r=A({},this.state.IP2MAC||{}),s=A({},this.state.MAC2VENDOR||{}),a=JSON.parse(JSON.stringify(this.state.ips));(d=o==null?void 0:o.result)==null||d.forEach(t=>{const l=t.ip,h=a.findIndex(v=>v.ip===l);h!==-1&&(a[h].mac=t.mac),r[D(l)]=t.mac,s[M(t.mac)]=t.vendor});let c=!1;e.forEach(t=>{const l=a.findIndex(h=>h.ip===t.ip);l!==-1&&a[l].mac&&t.mac!==a[l].mac&&(c=!0,t.mac=a[l].mac)}),this.setState({ips:a,IP2MAC:r,MAC2VENDOR:s,runningRequest:!1}),c&&this.onChange("devices",e)}).catch(o=>{o.toString()!=="no results"&&window.alert(`Cannot get MAC addresses: ${o}`),this.setState({runningRequest:!1})})})}static getAttr(e,n){if(Array.isArray(n)){const o=n.shift();return typeof e[o]=="object"?E.getAttr(e[o],n):n.length?null:e[o]}return E.getAttr(e,n.split("."))}static isIp(e){if(typeof e=="string"){if(e.match(/^\d+\.\d+\.\d+\.\d+$/))return"ipv4";if(e.match(/^[\da-fA-F:]+$/))return"ipv6"}return null}componentWillUnmount(){super.componentWillUnmount(),this.props.socket.unsubscribeState(`system.adapter.kisshome-research.${this.props.instance}.alive`,this.onAliveChanged),this.validateTimeout&&clearTimeout(this.validateTimeout),this.validateTimeout=null}validateAddresses(){this.validateTimeout&&clearTimeout(this.validateTimeout),this.validateTimeout=setTimeout(()=>{if(this.validateTimeout=null,!this.state.alive)return;const e=[],n=b.ConfigGeneric.getValue(this.props.data,"devices")||[],o=A({},this.state.IP2MAC),d=A({},this.state.MAC2VENDOR);n.forEach(r=>{const s=D(r.ip),a=M(r.mac);s&&$(r.ip)&&!o[s]?(o[s]="-",e.push(r),r.mac&&S(r.mac)&&!d[a]&&(d[a]="-")):r.mac&&S(r.mac)&&!d[a]&&(d[a]="-",e.push(r))}),e.length&&this.setState({resolving:!0,IP2MAC:o,MAC2VENDOR:d},()=>{this.props.socket.sendTo(`kisshome-research.${this.props.instance}`,"getMacForIps",e).then(r=>{var s;if(r!=null&&r.error){this.setState({resolving:!1});return}const a=A({},this.state.IP2MAC),c=A({},this.state.MAC2VENDOR);let t=!1;(s=r==null?void 0:r.result)==null||s.forEach(l=>{l.ip=M(l.ip),l.mac=M(l.mac),l.mac&&a[l.ip]!==l.mac&&(a[l.ip]=l.mac,t=!0),l.vendor&&c[l.mac]!==l.vendor&&(c[l.mac]=l.vendor,t=!0)}),t&&this.setState({IP2MAC:a,MAC2VENDOR:c,resolving:!1})})})},1e3)}collectIpAddresses(e,n,o){return V(this,null,function*(){let d=[];e=e||this.state.instances;for(let s=0;s<e.length;s++){const a=pe.find(c=>c.adapter===e[s].name);if(a&&e[s].native){const c=a.attr;if(a.attr&&e[s].native[c])if(a.arrayAttr){if(Array.isArray(e[s].native[c]))for(let t=0;t<e[s].native[c].length;t++){const l=e[s].native[c][t],h=E.getAttr(l,a.arrayAttr),v=E.isIp(h);if(v){const _=o.find(I=>I.ip===h);d.push({ip:h,type:v,desc:e[s].name,uuid:(_==null?void 0:_.uuid)||T()})}}}else{const t=E.getAttr(e[s].native,c),l=E.isIp(t);if(l){const h=o.find(v=>v.ip===t);d.push({ip:t,type:l,desc:e[s].name,uuid:(h==null?void 0:h.uuid)||T()})}}if(a.browse)try{(yield a.browse(this.props.socket,e[s].id.replace("system.adapter.",""))).forEach(l=>{const h=E.isIp(l.ip);if(h){const v=o.find(_=>_.ip===l.ip);d.push({ip:l.ip,type:h,desc:l.name||e[s].name,uuid:(v==null?void 0:v.uuid)||T()})}})}catch(t){console.error(`Cannot collect "${e[s]}": ${t}`)}if(a.clients)try{(yield ce(this.props.socket,e[s].id.replace("system.adapter.",""))).forEach(l=>{const h=E.isIp(l.ip);if(h){const v=o.find(_=>_.ip===l.ip);d.push({ip:l.ip,type:h,desc:l.name||e[s].name,uuid:(v==null?void 0:v.uuid)||T()})}})}catch(t){console.error(`Cannot collect "${e[s]}": ${t}`)}}else if(e[s].native.ip&&typeof e[s].native.ip=="string"&&e[s].native.ip.match(/^\d+\.\d+\.\d+\.\d+$/)){const c=o.find(t=>t.ip===e[s].native.ip);d.push({ip:e[s].native.ip,type:"ipv4",desc:e[s].name,uuid:(c==null?void 0:c.uuid)||T()})}else if(e[s].native.host&&typeof e[s].native.host=="string"&&e[s].native.host.match(/^\d+\.\d+\.\d+\.\d+$/)){const c=o.find(t=>t.ip===e[s].native.host);d.push({ip:e[s].native.host,type:"ipv4",desc:e[s].name,uuid:(c==null?void 0:c.uuid)||T()})}}d=d.filter(s=>!n.includes(s.ip)&&s.ip!=="0.0.0.0"&&s.ip!=="localhost"&&s.ip!=="127.0.0.1"&&s.ip!=="::1"&&s.type==="ipv4");const r=[];for(let s=0;s<d.length;s++)r.find(a=>a.ip===d[s].ip)||r.push(d[s]);return r})}renderMessage(){return this.state.showMessage?u().createElement(k.Message,{text:k.I18n.t("custom_kisshome_You cannot record the traffic of Fritz!Box"),onClose:()=>this.setState({showMessage:!1})}):null}disableFritzBox(){const e=b.ConfigGeneric.getValue(this.props.data,"devices")||[],n=b.ConfigGeneric.getValue(this.props.data,"fritzbox");let o=!1;e.forEach(d=>{d.ip===n&&d.enabled&&(o=!0,d.enabled=!1)}),o&&this.onChange("devices",e)}renderItem(e,n,o){var d;const r=b.ConfigGeneric.getValue(this.props.data,"devices")||[],s=b.ConfigGeneric.getValue(this.props.data,"fritzbox");r.forEach(t=>{t.uuid||(t.uuid=T())});const a=this.state.ips?r.filter(t=>!this.state.ips.find(l=>l.ip===t.ip)):r,c=r.every(t=>t.enabled)&&(this.state.ips?this.state.ips.every(t=>r.find(l=>l.ip===t.ip)):!0);return u().createElement(p.TableContainer,null,this.renderMessage(),this.state.runningRequest||this.state.resolving?u().createElement(p.LinearProgress,null):u().createElement("div",{style:{height:2,width:"100%"}}),u().createElement(p.Table,{style:g.table,size:"small"},u().createElement(p.TableHead,null,u().createElement(p.TableRow,null,u().createElement(p.TableCell,{style:ne(A({},g.header),{width:120})},u().createElement(p.Checkbox,{title:c?k.I18n.t("custom_kisshome_unselect_all"):k.I18n.t("custom_kisshome_select_all"),checked:c,indeterminate:!c&&r.length>0,disabled:this.state.runningRequest,onClick:()=>{const t=[...b.ConfigGeneric.getValue(this.props.data,"devices")||[]];if(c){t.forEach(l=>l.enabled=!1);for(let l=t.length-1;l>=0;l--)this.state.ips.find(h=>h.ip===t[l].ip)&&t.splice(l,1)}else t.forEach(l=>l.enabled=!0),this.state.ips.forEach(l=>{!t.find(h=>l.ip===h.ip)&&l.ip!==s&&t.push({ip:l.ip,mac:l.mac,desc:l.desc,enabled:!0,uuid:l.uuid})}),t.forEach(l=>l.enabled=!0);this.onChange("devices",t)}}),u().createElement(p.Fab,{onClick:()=>{const t=[...b.ConfigGeneric.getValue(this.props.data,"devices")||[]];t.push({ip:"",mac:"",desc:"",enabled:!0,uuid:T()}),this.onChange("devices",t)},size:"small",disabled:this.state.runningRequest},u().createElement(F.Add,null))),u().createElement(p.TableCell,{style:g.header},k.I18n.t("custom_kisshome_ip")),u().createElement(p.TableCell,{style:g.header},k.I18n.t("custom_kisshome_mac")),u().createElement(p.TableCell,{style:g.header},k.I18n.t("custom_kisshome_vendor")),u().createElement(p.TableCell,{style:g.header},k.I18n.t("custom_kisshome_name")),u().createElement(p.TableCell,{style:g.header}))),u().createElement(p.TableBody,null,(d=this.state.ips)==null?void 0:d.map(t=>{var l,h;return u().createElement(p.TableRow,{key:t.uuid},u().createElement(p.TableCell,{scope:"row",style:g.td},u().createElement(p.Checkbox,{checked:!!((l=r.find(v=>v.uuid===t.uuid))!=null&&l.enabled),disabled:this.state.runningRequest,onClick:()=>{const v=[...b.ConfigGeneric.getValue(this.props.data,"devices")||[]],_=v.findIndex(I=>I.uuid===t.uuid);if(_===-1){const I=v.findIndex(R=>R.ip===t.ip);if(I!==-1){const R=JSON.parse(JSON.stringify(this.state.ips)),P=R.find(f=>f.uuid===t.uuid);P.uuid=v[I].uuid,v[I].enabled=!0,this.setState({ips:R},()=>this.onChange("devices",v))}else{if(t.ip===s){this.setState({showMessage:!0});return}v.push({ip:t.ip,mac:t.mac,desc:t.desc,enabled:!0,uuid:t.uuid})}}else v.splice(_,1);this.onChange("devices",v)}})),u().createElement(p.TableCell,{style:g.td},t.ip),u().createElement(p.TableCell,{style:g.td},t.mac||""),u().createElement(p.TableCell,{style:A(A({},g.td),g.vendor)},((h=this.state.MAC2VENDOR)==null?void 0:h[M(t.mac)])||""),u().createElement(p.TableCell,{style:g.td},t.desc),u().createElement(p.TableCell,{style:g.td}))}),a.map(t=>{var l,h,v,_;const I=D(t.ip),R=M(t.mac),P=(l=this.state.IP2MAC)==null?void 0:l[I];return u().createElement(p.TableRow,{key:t.uuid},u().createElement(p.TableCell,{scope:"row",style:g.td},u().createElement(p.Checkbox,{checked:!!((h=r.find(f=>f.uuid===t.uuid))!=null&&h.enabled),disabled:this.state.runningRequest,onClick:()=>{const f=[...b.ConfigGeneric.getValue(this.props.data,"devices")||[]],m=f.find(y=>y.uuid===t.uuid);if(m){if(!m.enabled&&t.ip===s){this.setState({showMessage:!0});return}m.enabled=!m.enabled,this.onChange("devices",f)}}})),u().createElement(p.TableCell,{style:g.td},u().createElement(p.TextField,{fullWidth:!0,error:!$(t.ip),value:t.ip,disabled:this.state.runningRequest,placeholder:"192.168.x.y",onChange:f=>{const m=[...b.ConfigGeneric.getValue(this.props.data,"devices")||[]],y=m.find(j=>j.uuid===t.uuid);y&&(y.ip=f.target.value,y.ip===s&&y.enabled&&setTimeout(()=>this.disableFritzBox(),300),this.onChange("devices",m),this.validateAddresses())},onBlur:()=>{if(t.ip.trim()&&I!==t.ip){const f=[...b.ConfigGeneric.getValue(this.props.data,"devices")||[]],m=f.find(y=>y.uuid===t.uuid);m&&(m.ip=normalized,this.onChange("devices",f))}},variant:"standard"})),u().createElement(p.TableCell,{style:g.td},u().createElement(p.TextField,{fullWidth:!0,value:t.mac,disabled:this.state.runningRequest,error:!S(t.mac),placeholder:P||"XX:XX:XX:XX:XX:XX",onChange:f=>{const m=[...b.ConfigGeneric.getValue(this.props.data,"devices")||[]],y=m.find(j=>j.uuid===t.uuid);y&&(y.mac=f.target.value,this.onChange("devices",m),this.validateAddresses())},onBlur:()=>{if(t.mac.trim()){const f=R;if(f!==t.mac){const m=[...b.ConfigGeneric.getValue(this.props.data,"devices")||[]],y=m.find(j=>j.uuid===t.uuid);y&&(y.mac=f,this.onChange("devices",m))}}},variant:"standard"})),u().createElement(p.TableCell,{style:A(A({},g.td),g.vendor)},t.mac?((v=this.state.MAC2VENDOR)==null?void 0:v[R])||"":P&&((_=this.state.MAC2VENDOR)==null?void 0:_[P])||""),u().createElement(p.TableCell,{style:g.td},u().createElement(p.TextField,{fullWidth:!0,value:t.desc,disabled:this.state.runningRequest,onChange:f=>{const m=[...b.ConfigGeneric.getValue(this.props.data,"devices")||[]],y=m.find(j=>j.uuid===t.uuid);y&&(y.desc=f.target.value,this.onChange("devices",m))},variant:"standard"})),u().createElement(p.TableCell,{style:g.td},u().createElement(p.IconButton,{disabled:this.state.runningRequest,onClick:()=>{const f=[...b.ConfigGeneric.getValue(this.props.data,"devices")||[]],m=f.findIndex(y=>y.uuid===t.uuid);m!==-1&&(f.splice(m,1),this.onChange("devices",f))}},u().createElement(F.Delete,null))))}))))}}E.propTypes={socket:O().object.isRequired,themeType:O().string,themeName:O().string,style:O().object,data:O().object.isRequired,schema:O().object,onError:O().func,onChange:O().func};const he=E}}]);

//# sourceMappingURL=src_ConfigCustomInstancesSelector_jsx.7e63c36d.chunk.js.map