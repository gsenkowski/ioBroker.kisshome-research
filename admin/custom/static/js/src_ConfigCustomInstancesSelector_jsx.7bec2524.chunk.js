"use strict";(self.webpackChunkiobroker_admin_component_telegram=self.webpackChunkiobroker_admin_component_telegram||[]).push([["src_ConfigCustomInstancesSelector_jsx"],{94976:(fe,W,T)=>{T.d(W,{A:()=>ve});var B=T(28437),p=T.n(B),H=T(95973),M=T.n(H),J=typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const N={randomUUID:J};var G,L=new Uint8Array(16);function Y(){if(!G&&(G=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!G))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return G(L)}for(var E=[],z=0;z<256;++z)E.push((z+256).toString(16).slice(1));function F(s,e=0){return(E[s[e+0]]+E[s[e+1]]+E[s[e+2]]+E[s[e+3]]+"-"+E[s[e+4]]+E[s[e+5]]+"-"+E[s[e+6]]+E[s[e+7]]+"-"+E[s[e+8]]+E[s[e+9]]+"-"+E[s[e+10]]+E[s[e+11]]+E[s[e+12]]+E[s[e+13]]+E[s[e+14]]+E[s[e+15]]).toLowerCase()}function me(s,e=0){var a=F(s,e);if(!validate(a))throw TypeError("Stringified UUID is invalid");return a}const ge=null;function K(s,e,a){if(N.randomUUID&&!e&&!s)return N.randomUUID();s=s||{};var c=s.random||(s.rng||Y)();if(c[6]=c[6]&15|64,c[8]=c[8]&63|128,e){a=a||0;for(var o=0;o<16;++o)e[a+o]=c[o];return e}return F(c)}const O=K;var h=T(67085),X=T(21839),C=T(60556),k=T(37449),Q=Object.defineProperty,Z=Object.defineProperties,ee=Object.getOwnPropertyDescriptors,q=Object.getOwnPropertySymbols,te=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable,ne=Reflect.get,w=(s,e,a)=>e in s?Q(s,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[e]=a,I=(s,e)=>{for(var a in e||(e={}))ie.call(e,a)&&w(s,a,e[a]);if(q)for(var a of q(e))se.call(e,a)&&w(s,a,e[a]);return s},ae=(s,e)=>Z(s,ee(e)),re=(s,e,a)=>w(s,typeof e!="symbol"?e+"":e,a),le=(s,e,a)=>ne(te(s),a,e),R=(s,e,a)=>new Promise((c,o)=>{var l=u=>{try{r(a.next(u))}catch(t){o(t)}},n=u=>{try{r(a.throw(u))}catch(t){o(t)}},r=u=>u.done?c(u.value):Promise.resolve(u.value).then(l,n);r((a=a.apply(s,e)).next())});const g={table:{minWidth:400},header:{fontSize:16,fontWeight:"bold"},td:{padding:"2px 16px"},vendor:{maxWidth:150,fontSize:12,textOverflow:"ellipsis",overflow:"hidden"}};function de(s,e){return R(this,null,function*(){const a=yield s.getObjectViewSystem("state",`${e}.`,`${e}.\u9999`),c=[],o=Object.keys(a).filter(l=>l.endsWith(".address"));for(let l=0;l<o.length;l++){const n=o[l],r=yield s.getState(n);r!=null&&r.val&&c.push({ip:r.val,name:"homekit-controller"})}return c})}function oe(s,e){return R(this,null,function*(){const a=yield s.getObjectViewSystem("state",`${e}.`,`${e}.\u9999`),c=[],o=Object.keys(a).filter(l=>l.endsWith(".address"));for(let l=0;l<o.length;l++){const n=o[l],r=yield s.getState(n);r!=null&&r.val&&c.push({ip:r.val,name:"homekit-controller"})}return c})}function ce(s,e){return R(this,null,function*(){const a=yield s.getObjectViewSystem("state",`${e}.`,`${e}.\u9999`),c=[],o=Object.keys(a).filter(l=>l.endsWith(".hostname"));for(let l=0;l<o.length;l++){const n=o[l],r=yield s.getState(n);r!=null&&r.val&&c.push({ip:r.val,name:"shelly"})}return c})}function ue(s,e){return R(this,null,function*(){var a,c;const o=yield s.getObjectViewSystem("state",`${e}.info.clients.`,`${e}.info.clients.\u9999`),l=[],n=Object.values(o);for(let r=0;r<n.length;r++)(c=(a=n[r])==null?void 0:a.native)!=null&&c.ip&&l.push({ip:n[r].native.ip,name:e.split(".")[0]});return l})}function pe(s,e){return R(this,null,function*(){var a,c,o;const l=yield s.getObjectViewSystem("device",`${e}.`,`${e}.\u9999`),n=Object.values(l),r=[];for(let u=0;u<n.length;u++)((a=n[u])==null?void 0:a.type)==="device"&&((o=(c=n[u])==null?void 0:c.native)!=null&&o.ip)&&r.push({ip:n[u].native.ip,name:e.split(".")[0]});return r})}const he=[{adapter:"broadlink2",attr:"additional"},{adapter:"harmony",attr:"devices",arrayAttr:"ip"},{adapter:"hm-rpc",attr:"homematicAddress"},{adapter:"homeconnect",browse:oe},{adapter:"homekit-controller",attr:"discoverIp",browse:de},{adapter:"hue",attr:"bridge"},{adapter:"knx",attr:"bind"},{adapter:"lgtv",attr:"ip"},{adapter:"loxone",attr:"host"},{adapter:"mihome-vacuum",attr:"ip"},{adapter:"modbus",attr:"params.bind",clients:!0},{adapter:"mqtt",attr:"url",clients:!0},{adapter:"mqtt-client",attr:"host"},{adapter:"lcn",attr:"host"},{adapter:"knx",attr:"gwip"},{adapter:"onvif"},{adapter:"openknx",attr:"gwip"},{adapter:"broadlink2",attr:"additional"},{adapter:"proxmox",attr:"ip"},{adapter:"samsung",attr:"ip"},{adapter:"shelly",browse:ce},{adapter:"sonoff",clients:!0},{adapter:"sonos",attr:"devices",arrayAttr:"ip"},{adapter:"tr-064",attr:"iporhost"},{adapter:"unify",attr:"controllerIp"},{adapter:"upnp",browse:pe},{adapter:"wled",attr:"devices",arrayAttr:"ip"},{adapter:"wifilight",attr:"devices",arrayAttr:"ip"}];function $(s){return s?typeof s!="string"?!1:(s=s.trim().toUpperCase().replace(/\s/g,""),!s||s.match(/^([0-9A-F]{2}[:-]){5}([0-9A-F]{2})$/)?!0:!!s.match(/^([0-9A-F]{12})$/)):!0}function V(s){return!s||!$(s)?s:(s=s.toUpperCase().trim().replace(/[\s:-]/g,""),s.replace(/(..)(..)(..)(..)(..)(..)/,"$1:$2:$3:$4:$5:$6"))}function D(s){return s?typeof s!="string"?!1:(s=s.trim(),s?s.match(/^\d+\.\d+\.\d+\.\d+$/)?!s.trim().split(".").map(a=>parseInt(a,10)).find(a=>a<0||a>255):!1:!0):!0}function P(s){return!s||!D(s)?s:s.trim().split(".").map(a=>parseInt(a,10)).join(".")}class A extends C.ConfigGeneric{constructor(){super(...arguments),re(this,"onAliveChanged",(e,a)=>{this.state.alive!==!!(a!=null&&a.val)&&this.setState({alive:!!(a!=null&&a.val)},()=>{this.state.alive&&(this.resolveDone?this.validateAddresses():this.resolveMACs())})})}componentDidMount(){return R(this,null,function*(){le(A.prototype,this,"componentDidMount").call(this);let e=[];const a=yield this.props.socket.getObject(`system.adapter.kisshome-research.${this.props.instance}`);a!=null&&a.common.host&&(e=(yield this.props.socket.getObject(`system.host.${a.common.host}`)).common.address);let c=yield this.props.socket.getAdapterInstances();c=c.filter(r=>{var u;return((u=r==null?void 0:r.common)==null?void 0:u.adminUI)&&(r.common.adminUI.config!=="none"||r.common.adminUI.tab)}).map(r=>({id:r._id.replace(/^system\.adapter\./,""),name:r.common.name,native:r.native})).sort((r,u)=>r.id>u.id?1:r.id<u.id?-1:0);const o=C.ConfigGeneric.getValue(this.props.data,"devices")||[];o.forEach(r=>{r.uuid||(r.uuid=O())});const l=yield this.collectIpAddresses(c,e,o),n={instances:c,ips:l,IP2MAC:{},MAC2VENDOR:{},alive:this.props.alive,resolving:!1,showMessage:!1};this.resolveDone=!1,this.setState(n),this.props.socket.subscribeState(`system.adapter.kisshome-research.${this.props.instance}.alive`,this.onAliveChanged),this.props.alive&&this.resolveMACs(),this.disableFritzBox()})}resolveMACs(){this.resolveDone=!0,this.setState({runningRequest:!0},()=>{const e=[...C.ConfigGeneric.getValue(this.props.data,"devices")||[]],a=[];return e.forEach(c=>{const o=P(c.ip),l=V(c.mac);o&&D(o)?a.push({ip:o,mac:l}):l&&$(l)&&a.push({ip:o,mac:l})}),this.state.ips.forEach(c=>{const o=P(c.ip),l=V(c.mac);o&&D(o)&&!a.find(n=>n.ip===o)?a.push({ip:o,mac:l}):l&&$(l)&&!a.find(n=>n.ip===o)&&a.push({ip:o,mac:l})}),this.props.socket.sendTo(`kisshome-research.${this.props.instance}`,"getMacForIps",a).then(c=>{var o;if(c!=null&&c.error){this.setState({runningRequest:!1});return}const l=I({},this.state.IP2MAC||{}),n=I({},this.state.MAC2VENDOR||{}),r=JSON.parse(JSON.stringify(this.state.ips));(o=c==null?void 0:c.result)==null||o.forEach(t=>{const d=t.ip,v=r.findIndex(f=>f.ip===d);v!==-1&&(r[v].mac=t.mac),l[P(d)]=t.mac,n[V(t.mac)]=t.vendor});let u=!1;e.forEach(t=>{const d=r.findIndex(v=>v.ip===t.ip);d!==-1&&r[d].mac&&t.mac!==r[d].mac&&(u=!0,t.mac=r[d].mac)}),this.setState({ips:r,IP2MAC:l,MAC2VENDOR:n,runningRequest:!1}),u&&this.onChange("devices",e)}).catch(c=>{c.toString()!=="no results"&&window.alert(`Cannot get MAC addresses: ${c}`),this.setState({runningRequest:!1})})})}static getAttr(e,a){if(Array.isArray(a)){const c=a.shift();return typeof e[c]=="object"?A.getAttr(e[c],a):a.length?null:e[c]}return A.getAttr(e,a.split("."))}static isIp(e){if(typeof e=="string"){if(e.match(/^\d+\.\d+\.\d+\.\d+$/))return"ipv4";if(e.match(/^[\da-fA-F:]+$/))return"ipv6"}return null}componentWillUnmount(){super.componentWillUnmount(),this.props.socket.unsubscribeState(`system.adapter.kisshome-research.${this.props.instance}.alive`,this.onAliveChanged),this.validateTimeout&&clearTimeout(this.validateTimeout),this.validateTimeout=null}validateAddresses(){this.validateTimeout&&clearTimeout(this.validateTimeout),this.validateTimeout=setTimeout(()=>{if(this.validateTimeout=null,!this.state.alive)return;const e=[],a=C.ConfigGeneric.getValue(this.props.data,"devices")||[],c=I({},this.state.IP2MAC),o=I({},this.state.MAC2VENDOR);a.forEach(l=>{const n=P(l.ip),r=V(l.mac);n&&D(l.ip)&&!c[n]?(c[n]="-",e.push(l),l.mac&&$(l.mac)&&!o[r]&&(o[r]="-")):l.mac&&$(l.mac)&&!o[r]&&(o[r]="-",e.push(l))}),e.length&&this.setState({resolving:!0,IP2MAC:c,MAC2VENDOR:o},()=>{this.props.socket.sendTo(`kisshome-research.${this.props.instance}`,"getMacForIps",e).then(l=>{var n;if(l!=null&&l.error){this.setState({resolving:!1});return}const r=I({},this.state.IP2MAC),u=I({},this.state.MAC2VENDOR);let t=!1;(n=l==null?void 0:l.result)==null||n.forEach(d=>{d.ip=V(d.ip),d.mac=V(d.mac),d.mac&&r[d.ip]!==d.mac&&(r[d.ip]=d.mac,t=!0),d.vendor&&u[d.mac]!==d.vendor&&(u[d.mac]=d.vendor,t=!0)}),t&&this.setState({IP2MAC:r,MAC2VENDOR:u,resolving:!1})})})},1e3)}collectIpAddresses(e,a,c){return R(this,null,function*(){let o=[];e=e||this.state.instances;for(let n=0;n<e.length;n++){const r=he.find(u=>u.adapter===e[n].name);if(r&&e[n].native){const u=r.attr;if(r.attr&&e[n].native[u])if(r.arrayAttr){if(Array.isArray(e[n].native[u]))for(let t=0;t<e[n].native[u].length;t++){const d=e[n].native[u][t],v=A.getAttr(d,r.arrayAttr),f=A.isIp(v);if(f){const _=c.find(x=>x.ip===v);o.push({ip:v,type:f,desc:e[n].name,uuid:(_==null?void 0:_.uuid)||O()})}}}else{const t=A.getAttr(e[n].native,u),d=A.isIp(t);if(d){const v=c.find(f=>f.ip===t);o.push({ip:t,type:d,desc:e[n].name,uuid:(v==null?void 0:v.uuid)||O()})}}if(r.browse)try{(yield r.browse(this.props.socket,e[n].id.replace("system.adapter.",""))).forEach(d=>{const v=A.isIp(d.ip);if(v){const f=c.find(_=>_.ip===d.ip);o.push({ip:d.ip,type:v,desc:d.name||e[n].name,uuid:(f==null?void 0:f.uuid)||O()})}})}catch(t){console.error(`Cannot collect "${e[n]}": ${t}`)}if(r.clients)try{(yield ue(this.props.socket,e[n].id.replace("system.adapter.",""))).forEach(d=>{const v=A.isIp(d.ip);if(v){const f=c.find(_=>_.ip===d.ip);o.push({ip:d.ip,type:v,desc:d.name||e[n].name,uuid:(f==null?void 0:f.uuid)||O()})}})}catch(t){console.error(`Cannot collect "${e[n]}": ${t}`)}}else if(e[n].native.ip&&typeof e[n].native.ip=="string"&&e[n].native.ip.match(/^\d+\.\d+\.\d+\.\d+$/)){const u=c.find(t=>t.ip===e[n].native.ip);o.push({ip:e[n].native.ip,type:"ipv4",desc:e[n].name,uuid:(u==null?void 0:u.uuid)||O()})}else if(e[n].native.host&&typeof e[n].native.host=="string"&&e[n].native.host.match(/^\d+\.\d+\.\d+\.\d+$/)){const u=c.find(t=>t.ip===e[n].native.host);o.push({ip:e[n].native.host,type:"ipv4",desc:e[n].name,uuid:(u==null?void 0:u.uuid)||O()})}}o=o.filter(n=>!a.includes(n.ip)&&n.ip!=="0.0.0.0"&&n.ip!=="localhost"&&n.ip!=="127.0.0.1"&&n.ip!=="::1"&&n.type==="ipv4");const l=[];for(let n=0;n<o.length;n++)l.find(r=>r.ip===o[n].ip)||l.push(o[n]);return l})}renderMessage(){return this.state.showMessage?p().createElement(k.Message,{text:k.I18n.t("You cannot record the traffic of Fritz!Box"),onClose:()=>this.setState({showMessage:!1})}):null}disableFritzBox(){const e=C.ConfigGeneric.getValue(this.props.data,"devices")||[],a=C.ConfigGeneric.getValue(this.props.data,"fritzbox");let c=!1;e.forEach(o=>{o.ip===a&&o.enabled&&(c=!0,o.enabled=!1)}),c&&this.onChange("devices",e)}renderItem(e,a,c){var o;const l=C.ConfigGeneric.getValue(this.props.data,"devices")||[],n=C.ConfigGeneric.getValue(this.props.data,"fritzbox");l.forEach(t=>{t.uuid||(t.uuid=O())});const r=this.state.ips?l.filter(t=>!this.state.ips.find(d=>d.ip===t.ip)):l,u=l.every(t=>t.enabled)&&(this.state.ips?this.state.ips.every(t=>l.find(d=>d.ip===t.ip)):!0);return p().createElement(h.TableContainer,null,this.renderMessage(),this.state.runningRequest||this.state.resolving?p().createElement(h.LinearProgress,null):p().createElement("div",{style:{height:2,width:"100%"}}),p().createElement(h.Table,{style:g.table,size:"small"},p().createElement(h.TableHead,null,p().createElement(h.TableRow,null,p().createElement(h.TableCell,{style:ae(I({},g.header),{width:120})},p().createElement(h.Checkbox,{title:u?k.I18n.t("custom_kisshome_unselect_all"):k.I18n.t("custom_kisshome_select_all"),checked:u,indeterminate:!u&&l.length>0,disabled:this.state.runningRequest,onClick:()=>{const t=[...C.ConfigGeneric.getValue(this.props.data,"devices")||[]];if(u){t.forEach(d=>d.enabled=!1);for(let d=t.length-1;d>=0;d--)this.state.ips.find(v=>v.ip===t[d].ip)&&t.splice(d,1)}else t.forEach(d=>d.enabled=!0),this.state.ips.forEach(d=>{!t.find(v=>d.ip===v.ip)&&d.ip!==n&&t.push({ip:d.ip,mac:d.mac,desc:d.desc,enabled:!0,uuid:d.uuid})}),t.forEach(d=>d.enabled=!0);this.onChange("devices",t)}}),p().createElement(h.Fab,{onClick:()=>{const t=[...C.ConfigGeneric.getValue(this.props.data,"devices")||[]];t.push({ip:"",mac:"",desc:"",enabled:!0,uuid:O()}),this.onChange("devices",t)},size:"small",disabled:this.state.runningRequest},p().createElement(X.Add,null))),p().createElement(h.TableCell,{style:g.header},k.I18n.t("custom_kisshome_ip")),p().createElement(h.TableCell,{style:g.header},k.I18n.t("custom_kisshome_mac")),p().createElement(h.TableCell,{style:g.header},k.I18n.t("custom_kisshome_vendor")),p().createElement(h.TableCell,{style:g.header},k.I18n.t("custom_kisshome_name")),p().createElement(h.TableCell,{style:g.header}))),p().createElement(h.TableBody,null,(o=this.state.ips)==null?void 0:o.map(t=>{var d,v;return p().createElement(h.TableRow,{key:t.uuid},p().createElement(h.TableCell,{scope:"row",style:g.td},p().createElement(h.Checkbox,{checked:!!((d=l.find(f=>f.uuid===t.uuid))!=null&&d.enabled),disabled:this.state.runningRequest,onClick:()=>{const f=[...C.ConfigGeneric.getValue(this.props.data,"devices")||[]],_=f.findIndex(x=>x.uuid===t.uuid);if(_===-1){const x=f.findIndex(j=>j.ip===t.ip);if(x!==-1){const j=JSON.parse(JSON.stringify(this.state.ips)),U=j.find(m=>m.uuid===t.uuid);U.uuid=f[x].uuid,f[x].enabled=!0,this.setState({ips:j},()=>this.onChange("devices",f))}else{if(t.ip===n){this.setState({showMessage:!0});return}f.push({ip:t.ip,mac:t.mac,desc:t.desc,enabled:!0,uuid:t.uuid})}}else f.splice(_,1);this.onChange("devices",f)}})),p().createElement(h.TableCell,{style:g.td},t.ip),p().createElement(h.TableCell,{style:g.td},t.mac||""),p().createElement(h.TableCell,{style:I(I({},g.td),g.vendor)},((v=this.state.MAC2VENDOR)==null?void 0:v[V(t.mac)])||""),p().createElement(h.TableCell,{style:g.td},t.desc),p().createElement(h.TableCell,{style:g.td}))}),r.map(t=>{var d,v,f,_;const x=P(t.ip),j=V(t.mac),U=(d=this.state.IP2MAC)==null?void 0:d[x];return p().createElement(h.TableRow,{key:t.uuid},p().createElement(h.TableCell,{scope:"row",style:g.td},p().createElement(h.Checkbox,{checked:!!((v=l.find(m=>m.uuid===t.uuid))!=null&&v.enabled),disabled:this.state.runningRequest,onClick:()=>{const m=[...C.ConfigGeneric.getValue(this.props.data,"devices")||[]],y=m.find(b=>b.uuid===t.uuid);if(y){if(!y.enabled&&t.ip===n){this.setState({showMessage:!0});return}y.enabled=!y.enabled,this.onChange("devices",m)}}})),p().createElement(h.TableCell,{style:g.td},p().createElement(h.TextField,{fullWidth:!0,error:!D(t.ip),value:t.ip,disabled:this.state.runningRequest,placeholder:"192.168.x.y",onChange:m=>{const y=[...C.ConfigGeneric.getValue(this.props.data,"devices")||[]],b=y.find(S=>S.uuid===t.uuid);b&&(b.ip=m.target.value,b.ip===n&&b.enabled&&setTimeout(()=>this.disableFritzBox(),300),this.onChange("devices",y),this.validateAddresses())},onBlur:()=>{if(t.ip.trim()&&x!==t.ip){const m=[...C.ConfigGeneric.getValue(this.props.data,"devices")||[]],y=m.find(b=>b.uuid===t.uuid);y&&(y.ip=normalized,this.onChange("devices",m))}},variant:"standard"})),p().createElement(h.TableCell,{style:g.td},p().createElement(h.TextField,{fullWidth:!0,value:t.mac,disabled:this.state.runningRequest,error:!$(t.mac),placeholder:U||"XX:XX:XX:XX:XX:XX",onChange:m=>{const y=[...C.ConfigGeneric.getValue(this.props.data,"devices")||[]],b=y.find(S=>S.uuid===t.uuid);b&&(b.mac=m.target.value,this.onChange("devices",y),this.validateAddresses())},onBlur:()=>{if(t.mac.trim()){const m=j;if(m!==t.mac){const y=[...C.ConfigGeneric.getValue(this.props.data,"devices")||[]],b=y.find(S=>S.uuid===t.uuid);b&&(b.mac=m,this.onChange("devices",y))}}},variant:"standard"})),p().createElement(h.TableCell,{style:I(I({},g.td),g.vendor)},t.mac?((f=this.state.MAC2VENDOR)==null?void 0:f[j])||"":U&&((_=this.state.MAC2VENDOR)==null?void 0:_[U])||""),p().createElement(h.TableCell,{style:g.td},p().createElement(h.TextField,{fullWidth:!0,value:t.desc,disabled:this.state.runningRequest,onChange:m=>{const y=[...C.ConfigGeneric.getValue(this.props.data,"devices")||[]],b=y.find(S=>S.uuid===t.uuid);b&&(b.desc=m.target.value,this.onChange("devices",y))},variant:"standard"})),p().createElement(h.TableCell,{style:g.td},p().createElement(h.IconButton,{disabled:this.state.runningRequest,onClick:()=>{const m=[...C.ConfigGeneric.getValue(this.props.data,"devices")||[]];m.findIndex(b=>b.uuid===t.uuid)!==-1&&(m.splice(i,1),this.onChange("devices",m))}},p().createElement(X.Delete,null))))}))))}}A.propTypes={socket:M().object.isRequired,themeType:M().string,themeName:M().string,style:M().object,data:M().object.isRequired,schema:M().object,onError:M().func,onChange:M().func};const ve=A}}]);

//# sourceMappingURL=src_ConfigCustomInstancesSelector_jsx.7bec2524.chunk.js.map